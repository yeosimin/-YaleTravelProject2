<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>상품 상세 정보</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <style>
        .highlight {
            background-color: #ffcccc;
        }
    </style>
    <script>
        $(function() {
            var productDetails = [];

            $(".product-detail").each(function() {
                var firstDay = new Date($(this).data('first-day'));
                var lastDay = new Date($(this).data('last-day'));
                productDetails.push({ firstDay: firstDay, lastDay: lastDay });
            });

            $("#datepicker").datepicker({
                beforeShowDay: function(date) {
                    for (var i = 0; i < productDetails.length; i++) {
                        if (date >= productDetails[i].firstDay && date <= productDetails[i].lastDay) {
                            return [true, 'highlight', ''];
                        }
                    }
                    return [true, '', ''];
                },
                onSelect: function(dateText) {
                    updateProductDetails(dateText);
                }
            });

            function calculateTotalPrice() {
                var adultCount = parseInt($("#adultCount").val());
                var teenagerCount = parseInt($("#teenagerCount").val());
                var infantCount = parseInt($("#infantCount").val());

                var adultPrice = parseInt($("#adultPrice").text());
                var teenagerPrice = parseInt($("#teenagerPrice").text());
                var infantPrice = parseInt($("#infantPrice").text());

                var maxTotalCount = parseInt($("#maxAdultCount").text());
                if (isNaN(maxTotalCount)) {
                    maxTotalCount = 0; // 기본값 설정
                }

                var totalCount = adultCount + teenagerCount + infantCount;

                if (maxTotalCount > 0 && totalCount > maxTotalCount) {
                    alert('총 인원이 최대 인원을 초과했습니다. 다시 입력해 주세요.');
                    $("#adultCount").val(1);
                    $("#teenagerCount").val(0);
                    $("#infantCount").val(0);
                    $("#totalPrice").text('0');
                    return;
                }

                if (isNaN(adultCount) || adultCount < 1) {
                    $("#totalPrice").text('0');
                    return;
                }

                var totalPrice = (adultCount * adultPrice) + (teenagerCount * teenagerPrice) + (infantCount * infantPrice);
                $("#totalPrice").text(totalPrice);
            }

            $("#adultCount, #teenagerCount, #infantCount").on('input', calculateTotalPrice);

            function updateProductDetails(dateText) {
                var selectedDate = new Date(dateText);
                var found = false;

                $(".product-detail").each(function() {
                    var firstDay = new Date($(this).data('first-day'));
                    var lastDay = new Date($(this).data('last-day'));

                    if (selectedDate >= firstDay && selectedDate <= lastDay) {
                        $(this).show();
                        found = true;

                        // 상세 정보 업데이트
                        var maxAdultCount = $(this).find("#maxAdultCount").text();
                        $("#maxAdultCount").text(maxAdultCount ? maxAdultCount : '무제한'); // 최대 인원수가 없을 경우 기본값

                        $("#adultPrice").text($(this).find("#adultPrice").text());
                        $("#teenagerPrice").text($(this).find("#teenagerPrice").text());
                        $("#infantPrice").text($(this).find("#infantPrice").text());

                        calculateTotalPrice();
                    } else {
                        $(this).hide();
                    }
                });

                if (!found) {
                    alert('해당 날짜에 맞는 상세 정보가 없습니다.');
                }
            }

            // 초기화 - 모든 상세 정보를 숨김
            $(".product-detail").hide();

            // 페이지 로드 시 초기 총 금액 계산
            calculateTotalPrice();
        });
    </script>

</head>
<body>
<h1>상품 상세 정보</h1>
<div>
    <img th:src="${product.productImageUrl}" alt="상품 이미지" style="max-width: 200px;" />
    <h2 th:text="${product.productName}"></h2>
    <p th:text="${product.productDescription}"></p>
    <p th:text="${product.productIsInternational ? '해외' : '국내'}"></p>
    <p th:text="${product.productFlag ? '삭제' : '판매 중'}"></p>
    <p>
        <span th:switch="${product.productPlaceOfDeparture}">
            <span th:case="1">인천국제공항</span>
            <span th:case="2">김포국제공항</span>
            <span th:case="3">제주국제공항</span>
            <span th:case="4">부산 김해국제공항</span>
            <span th:case="5">대구국제공항</span>
            <span th:case="6">청주국제공항</span>
            <span th:case="7">무안국제공항</span>
            <span th:case="8">양양국제공항</span>
            <span th:case="*">알 수 없음</span>
        </span>
    </p>
</div>

<div>
    <label for="datepicker">출발 날짜:</label>
    <div id="datepicker"></div>
</div>
<div th:each="productDetail : ${productDetails}" class="product-detail"
     th:attr="data-first-day=${productDetail.productDetailFirstDay}, data-last-day=${productDetail.productDetailLastDay}">
    <h2>상세 정보</h2>
    <p>상품아이디: <span th:text="${productDetail.productDetailId}"></span></p>
    <p>투어 첫날: <span th:text="${productDetail.productDetailFirstDay}"></span></p>
    <p>투어 마지막날: <span th:text="${productDetail.productDetailLastDay}"></span></p>
    <p>총 몇명: <span id="maxAdultCount" th:text="${productDetail.productDetailTotalCount}"></span></p>
    <p>성인 가격: <span id="adultPrice" th:text="${productDetail.productAdultPrice}"></span></p>
    <p>청소년 가격: <span id="teenagerPrice" th:text="${productDetail.productTeenagerPrice}"></span></p>
    <p>유아 가격: <span id="infantPrice" th:text="${productDetail.productInfantPrice}"></span></p>
    <p>항공사:
        <span th:switch="${productDetail.productDetailAirplane}">
            <span th:case="'0'">아시아나항공</span>
            <span th:case="'1'">대한항공</span>
            <span th:case="'2'">진에어</span>
            <span th:case="'3'">제주항공</span>
            <span th:case="*">Unknown</span>
        </span>
    </p>
</div>

<div>
    <label for="adultCount">성인 인원:</label>
    <input type="number" id="adultCount" value="1" min="1">
</div>
<div>
    <label for="teenagerCount">청소년 인원:</label>
    <input type="number" id="teenagerCount" value="0" min="0">
</div>
<div>
    <label for="infantCount">유아 인원:</label>
    <input type="number" id="infantCount" value="0" min="0">
</div>

<!-- 총 가격 -->
<div>
    <p>총 가격: <span id="totalPrice">0</span>원</p>
</div>

<!-- 예약 버튼 -->
<div>
    <button id="reserveButton">예약</button>
</div>

</body>
</html>
